generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Project {
  id                  String          @id @default(uuid())
  name                String
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  isFavorite          Boolean         @default(false)
  companyId           String
  conversationSummary String?
  agentActions        AgentAction[]
  messages            Message[]
  company             Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sandbox             ProjectSandbox?
}

model Company {
  id                       String              @id @default(uuid())
  name                     String
  codeLabel                String?
  codeHash                 String              @unique
  creditBalance            Int                 @default(0)
  totalCreditsGranted      Int                 @default(0)
  totalCreditsSpent        Int                 @default(0)
  projectsCreated          Int                 @default(0)
  lastActiveAt             DateTime?
  createdAt                DateTime            @default(now())
  updatedAt                DateTime            @updatedAt
  buildTourCompleted       Boolean             @default(false)
  projectsTourCompleted    Boolean             @default(false)
  projectViewTourCompleted Boolean             @default(false)
  sessions                 CompanySession[]
  creditTransactions       CreditTransaction[]
  projects                 Project[]
}

model CompanySession {
  id         String    @id @default(uuid())
  token      String    @unique
  companyId  String
  createdAt  DateTime  @default(now())
  expiresAt  DateTime?
  lastSeenAt DateTime  @default(now())
  userAgent  String?
  ipAddress  String?
  company    Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model CreditTransaction {
  id        String   @id @default(uuid())
  companyId String
  amount    Int
  reason    String
  metadata  Json?
  createdAt DateTime @default(now())
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model Message {
  id        String      @id @default(uuid())
  content   String
  role      MessageRole
  type      MessageType
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  projectId String
  fragment  Fragment?
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Fragment {
  id         String   @id @default(uuid())
  messageId  String   @unique
  sandboxUrl String
  title      String
  files      Json
  summary    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  message    Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
}

model ProjectSandbox {
  id           String        @id @default(uuid())
  projectId    String        @unique
  sandboxId    String
  sandboxUrl   String
  status       SandboxStatus @default(STARTING)
  lastActiveAt DateTime      @default(now())
  
  // Enhanced state tracking
  lastVerifiedAt       DateTime? // Last successful E2B API verification
  verificationFailures Int       @default(0) // Consecutive verification failures
  killedAt             DateTime? // Timestamp when marked as KILLED
  killedReason         String?   // Why sandbox was killed (manual, expired, terminated)
  
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model AgentAction {
  id          String            @id @default(uuid())
  projectId   String
  key         AgentActionKey
  label       String
  detail      String?
  status      AgentActionStatus @default(IN_PROGRESS)
  metadata    Json?
  startedAt   DateTime          @default(now())
  completedAt DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  project     Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

enum MessageRole {
  USER
  ASSISTANT
}

enum MessageType {
  RESULT
  ERROR
}

enum AgentActionStatus {
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum AgentActionKey {
  INITIALIZE
  LOAD_CONVERSATION_CONTEXT
  GET_SANDBOX_ID
  HYDRATE_SANDBOX
  NETWORK_RUN
  GET_SANDBOX_URL
  SAVE_RESULT
  TERMINAL
  CREATE_OR_UPDATE_FILES
  READ_FILES
}

enum SandboxStatus {
  STARTING
  RUNNING
  PAUSED
  KILLED          // Manually terminated via dashboard or API
  EXPIRED         // Reached maximum lifetime timeout
  TERMINATED      // System or user intentional shutdown
  UNKNOWN         // Cannot verify state (API errors)
}
